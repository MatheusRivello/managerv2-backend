name: ManagerV2-Backend-CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  Database:
    runs-on: ubuntu-latest
    
    services:
      mariadb:
        image: mariadb:latest
        env:
          MYSQL_ROOT_PASSWORD: 123456
          MYSQL_DATABASE: central_afv
          MYSQL_USER: painel_temporario
          MYSQL_PASSWORD: 123456
        ports:
          - "3306:3306"
        volumes:
          - ./database/dump:/docker-entrypoint-initdb.d
        options: --health-cmd="mariadb -h localhost -u root -p'123456' -e 'USE central_afv; SELECT COUNT(*) FROM versao_app';" --health-interval=10s --health-timeout=30s --health-retries=3 --health-start-period=50s

    steps:
    - name: Checkout code
      uses: actions/checkout@v3.1.0
    
    - name: Verificando se o container esta em execução
      run: docker container exec mariadb mariadb -h localhost -u root -p'123456' -e 'USE central_afv; SELECT COUNT(*) FROM versao_app;'

  Teste-Unitario:
    runs-on: ubuntu-latest
    needs: [Database]
    steps:

    - uses: shivammathur/setup-php@15c43e89cdef867065b0213be354c2841860869e
      with:
        php-version: '7.4'    

    - uses: actions/checkout@v3.1.0
        
    - name: Install Dependencies
      run: composer install
    
    - name: Testes unitários
      run: php artisan test